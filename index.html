<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Free Viewing Task - MouseView</title>
    <link rel="stylesheet" href="css/experiment.css">
    <link rel="stylesheet" href="css/mouseview.css">
    <style>
        .hide-during-practice {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        #progress-indicator.hide-during-practice {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -1 !important;
        }
    </style>
</head>
<body>
    <div id="experiment-container">
        
        <!-- Role Selection Screen (Landing Page) -->
        <div id="role-selection-screen" class="screen active">
            <div class="content-wrapper">
                <h1>Free Viewing Task</h1>
                <div class="instructions">
                    <p>Welcome to the Free Viewing Experiment. Please select your role:</p>
                </div>
                
                <div class="role-selection-buttons">
                    <div class="role-card">
                        <button id="participant-role-btn" class="primary-button">
                            üë§ Participant
                        </button>
                        <p class="role-description">
                            Take part in the experiment
                        </p>
                    </div>
                    
                    <div class="role-card">
                        <button id="admin-role-btn" class="secondary-button">
                            üîê Admin
                        </button>
                        <p class="role-description">
                            Access data dashboard
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participant Welcome Screen -->
        <div id="welcome-screen" class="screen">
            <div class="content-wrapper">
                <h1>Welcome!</h1>
                <div class="instructions">
                    <p>In this experiment, you will view a series of images using your mouse cursor as a "spotlight" of attention. Only the area around your cursor will be visible clearly, while other areas will be blurred.</p>
                    
                    <p>You will complete the main experiment with multiple trials.</p>

                    <p>Each trial begins when you click the "Start" or "Next" button in the center. After clicking, four images will appear in the corners of the screen for 15 seconds.</p>

                    <p><strong>Important:</strong> Please do not navigate away from this experiment until you reach the Thank You page.</p>
                    
                    <p>When you are ready, press <strong>SPACEBAR</strong> to begin.</p>
                </div>
                <button id="start-experiment" class="primary-button">Press SPACE to Begin</button>
            </div>
        </div>

        <!-- Participant Info Screen -->
        <div id="participant-screen" class="screen">
            <div class="content-wrapper">
                <h2>Participant Information</h2>
                <form id="participant-form">
                    <div class="form-group">
                        <label for="participant-id">Participant ID:</label>
                        <input type="text" id="participant-id" name="participant-id" required>
                    </div>
                    <div class="form-group">
                        <label for="participant-email">Email Address:</label>
                        <input type="email" id="participant-email" name="participant-email" required>
                    </div>
                    <div class="form-group">
                        <label for="session">Session:</label>
                        <input type="text" id="session" name="session" value="001" required>
                    </div>
                    <button type="submit" class="primary-button">Start Experiment</button>
                </form>
            </div>
        </div>

        <!-- Practice Screen -->
        <div id="practice-screen" class="screen">
            <div class="content-wrapper">
                <h2>Practice Trial</h2>
                <p id="practice-instructions">Let's practice! You'll see 4 images arranged in different positions. Move your mouse cursor to look at the images - it acts as your "spotlight" of attention. There's no right or wrong way to look. Just explore the images naturally.</p>
                <p id="practice-progress">Preparing practice trial...</p>
            </div>
            <button id="skip-practice" class="secondary-button">Skip Practice</button>
        </div>

        <!-- Main Experiment Screen -->
        <div id="experiment-screen" class="screen">
            <!-- Fixation Cross -->
            <div id="fixation-cross" class="fixation-cross">+</div>
            
            <!-- Center Start Button for Practice -->
            <div id="practice-start-button" class="center-button" style="display: none;">
                <button class="start-button">Start</button>
                <p class="button-instruction">Click to start practice</p>
            </div>
            
            <!-- Center Start Button for First Main Trial -->
            <div id="main-start-button" class="center-button" style="display: none;">
                <button class="start-button">Start</button>
                <p class="button-instruction">Click to start first trial</p>
            </div>
            
            <!-- Center Next Button for Between Trials -->
            <div id="next-trial-button" class="center-button" style="display: none;">
                <button class="next-button">Next</button>
                <p class="button-instruction">Click to continue to next trial</p>
            </div>
            
            <!-- Progress Indicator -->
            <div id="progress-indicator">
                <span id="current-trial">1</span> / <span id="total-trials">20</span>
            </div>
            
            <!-- Practice Indicator -->
            <div id="practice-indicator" style="display: none; position: absolute; top: 20px; right: 20px; background: rgba(255, 165, 0, 0.9); color: white; padding: 10px 15px; border-radius: 5px; font-weight: bold; z-index: 1000;">
                Practice Round
            </div>
            
            <!-- Image Container -->
            <div id="image-container">
                <img id="top-left-image" class="stimulus-image" alt="Top Left Image">
                <img id="top-right-image" class="stimulus-image" alt="Top Right Image">
                <img id="bottom-left-image" class="stimulus-image" alt="Bottom Left Image">
                <img id="bottom-right-image" class="stimulus-image" alt="Bottom Right Image">
                
                <!-- Image category labels (for debugging - can be hidden) -->
                <div class="image-labels">
                    <span id="top-left-label" class="image-label">Dysphoric</span>
                    <span id="top-right-label" class="image-label">Threat</span>
                    <span id="bottom-left-label" class="image-label">Positive</span>
                    <span id="bottom-right-label" class="image-label">Neutral</span>
                </div>
            </div>
            
            <!-- Continue Button (for manual progression) -->
            <button id="continue-trial" class="continue-button" style="display: none;">Continue to Next Trial</button>
        </div>

        <!-- Transition Screen (between practice and main experiment) -->
        <div id="transition-screen" class="screen">
            <div class="content-wrapper">
                <h2>Ready for Main Experiment</h2>
                <div class="instructions">
                    <p>Great job with the practice!</p>
                    <p>You are now ready to begin the main experiment.</p>
                    <p>Each trial lasts 15 seconds. Move your mouse naturally to look at the images.</p>
                    <p>When you're ready, press <strong>SPACEBAR</strong> or click the button below to begin.</p>
                </div>
                <button id="start-main-experiment" class="primary-button">Start Main Experiment</button>
            </div>
        </div>

        <!-- Data Processing Screen -->
        <div id="processing-screen" class="screen">
            <div class="content-wrapper">
                <h2>Processing Your Data</h2>
                <div class="loading-spinner"></div>
                <p id="processing-message">Please do not navigate away from this page while your data is being processed...</p>
                
                <div id="processing-steps" style="margin: 30px 0; text-align: center; max-width: 500px;">
                    <div class="processing-step active" id="step-sending">
                        <span class="step-icon">üì§</span>
                        <span class="step-text">Sending data to researcher...</span>
                    </div>
                </div>
                
                <div id="processing-progress" style="margin: 20px 0;">
                    <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="processing-progress-bar" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.5s;"></div>
                    </div>
                    <p id="processing-percent" style="margin: 10px 0; font-weight: bold;">Processing...</p>
                </div>
                
                <p style="color: #666; font-size: 0.9em; margin-top: 30px;">
                    <strong>Important:</strong> Do not close this tab or navigate away until processing is complete.
                </p>
            </div>
        </div>

        <!-- Thank You Screen (Final) -->
        <div id="thank-you-screen" class="screen">
            <div class="content-wrapper">
                <h2>Thank You!</h2>
                <div style="font-size: 3em; margin: 20px 0;">‚úÖ</div>
                <p style="font-size: 1.2em; margin: 20px 0;">Your participation has been successfully recorded.</p>
                <p>Your data has been securely transmitted to the research team.</p>
                <p style="margin: 30px 0; padding: 20px; background: #f0f9ff; border-radius: 10px; color: #1e40af;">
                    <strong>Data Processing Complete!</strong><br>
                    All your responses and attention patterns have been saved and will contribute to important research.
                </p>
                
                <div style="margin: 40px 0;">
                    <p style="color: #666; font-size: 0.9em;">
                        If you have any questions about this study, please contact the research team.
                    </p>
                </div>
                
                <button id="close-experiment" class="primary-button" style="margin-top: 20px;">
                    Close Experiment
                </button>
            </div>
        </div>

        <!-- Admin Login Screen -->
        <div id="admin-login-screen" class="screen">
            <div class="content-wrapper">
                <h2>üîê Admin Login</h2>
                <p style="margin-bottom: 30px;">Please enter your admin credentials to access the data dashboard.</p>
                
                <form id="admin-login-form" style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label for="admin-username">Username:</label>
                        <input type="text" id="admin-username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-password">Password:</label>
                        <input type="password" id="admin-password" name="password" required>
                    </div>
                    
                    <button type="submit" class="primary-button">Login</button>
                    <button type="button" id="back-to-roles" class="secondary-button" style="margin-left: 10px;">Back</button>
                </form>
                
                <div id="admin-login-error" style="display: none; color: #d32f2f; margin-top: 20px; font-weight: bold;">
                    Invalid credentials. Please try again.
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Screen -->
        <div id="admin-dashboard-screen" class="screen">
            <div class="content-wrapper">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>üìä Admin Dashboard</h2>
                    <button id="admin-logout" class="secondary-button">Logout</button>
                </div>
                
                <div id="storage-overview" style="margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: rgba(255,255,255,0.9);">üìä Storage Overview</h3>
                    <div id="storage-stats">
                        <p style="color: rgba(255,255,255,0.7);">Loading storage information...</p>
                    </div>
                </div>
                
                <div id="participant-data-list">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: rgba(255,255,255,0.9);">üë• Participant Data</h3>
                    <div id="data-list-container">
                        <p style="color: rgba(255,255,255,0.7);">Loading participant data...</p>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: rgba(255,193,7,0.08); border: 1px solid rgba(255,193,7,0.2); border-radius: 8px;">
                    <h4 style="color: #FFC107; margin-bottom: 10px;">‚ö†Ô∏è Data Management</h4>
                    <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 14px;">Data is automatically deleted after 7 days. Use the cleanup button to remove expired data manually.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="cleanup-expired-data" class="secondary-button" style="background: rgba(255,193,7,0.2); border-color: rgba(255,193,7,0.4);">üßπ Remove Expired</button>
                        <button id="clear-all-data" class="secondary-button" style="background: rgba(211,47,47,0.3); border-color: rgba(211,47,47,0.5);">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden Admin/Debug Screen (for researchers only) -->
        <div id="admin-screen" class="screen" style="display: none;">
            <div class="content-wrapper">
                <h2>Admin Controls</h2>
                <p style="color: #d32f2f; font-weight: bold;">For researchers only - not shown to participants</p>
                
                <div id="download-buttons" style="margin: 20px 0;">
                    <button id="download-trial-data" class="primary-button">Download Trial Data</button>
                    <button id="download-mouse-data" class="primary-button">Download Mouse Data</button>
                    <button id="download-trial-heatmaps" class="primary-button">Download Trial Heatmaps (ZIP)</button>
                </div>
                
                <div id="heatmap-progress" style="display: none; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 5px;">
                    <div style="margin-bottom: 10px; font-weight: bold;" id="heatmap-progress-text">Generating heatmaps...</div>
                    <div style="background: #ddd; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="heatmap-progress-bar" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <button id="restart-experiment" class="secondary-button">Restart Experiment</button>
                <button id="show-thank-you" class="secondary-button">Return to Thank You Screen</button>
            </div>
        </div>


        <!-- Loading Screen -->
        <div id="loading-screen" class="screen">
            <div class="content-wrapper">
                <h2>Loading...</h2>
                <div class="loading-spinner"></div>
                <p id="loading-message">Preparing experiment...</p>
            </div>
        </div>

    </div>

    <!-- MouseView Overlay -->
    <div id="mouseview-overlay" class="mouseview-overlay"></div>

    <!-- Scripts -->
    <!-- JSZip library for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- EmailJS library for sending emails -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- Supabase client library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Official MouseView.js library -->
    <script src="https://mouseview-docs.netlify.app/MouseView.js" type="module"></script>
    <!-- Your custom scripts -->
    <script src="js/experiment-utils.js?v=2025-08-10-refactor"></script>
    <script src="js/data-manager.js?v=2025-07-28-fix"></script>
    <script src="js/image-manager.js?v=2025-07-28-fix"></script>
    <script src="js/practice-manager.js?v=2025-07-28-fix"></script>
    <script src="js/admin-manager.js?v=2025-07-28-fix"></script>
    <script src="js/experiment.js?v=2025-07-28-fix"></script>

    <script type="module">
        // Initialize EmailJS (replace with your actual EmailJS credentials)
        (function() {
            // EmailJS configuration - REPLACE THESE VALUES
            emailjs.init({
                publicKey: 'ES-FZtiy_aE5x8CC7', // Your actual public key
            });
            
            // Store EmailJS configuration globally for access by DataManager
            window.EMAIL_CONFIG = {
                serviceID: 'service_uenfs4k',        // Replace with your service ID
                templateID: 'template_9qqxaxa',      // Replace with your template ID
                researcherEmail: 'szeling.tan@u.nus.edu' // Replace with researcher's email
            };
            
            console.log('EmailJS initialized');
        })();
        
        // Initialize Supabase (you'll need to replace these with your actual credentials)
        (function() {
            // SUPABASE CONFIGURATION - REPLACE THESE VALUES
            const SUPABASE_URL = 'https://lcrxhfpvkllgzmnhyios.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjcnhoZnB2a2xsZ3ptbmh5aW9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MjUyMTUsImV4cCI6MjA3MDQwMTIxNX0.S7fIqcR1eZ0U6A_u3fyz5QGQg9Aq6M5Yy4J3j5sdPiM'; // Your anon/public key
            
            // Initialize Supabase client globally
            if (typeof supabase !== 'undefined') {
                window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized');
                console.log('‚úÖ Supabase configured successfully');
            } else {
                console.error('Supabase library not loaded');
            }
        })();
        
        // Configure MouseView.js parameters and initialize experiment
        window.addEventListener('load', () => {
            // Basic MouseView.js initialization (configuration happens only during trials)
            if (typeof mouseview !== 'undefined') {
                // Only set basic timing parameters globally
                mouseview.timing.sampleRate = 16.66; // ~60Hz sampling rate
                mouseview.params.overlayGaussian = 0; // Disable overlay blur for performance
                
                console.log('MouseView.js basic initialization complete');
            }
            
            // Initialize admin system
            window.adminManager = new AdminManager();
            window.adminManager.init();
            
            // Initialize your experiment
            const experiment = new ExperimentController();
            experiment.init();
        });
    </script>
</body>
</html>